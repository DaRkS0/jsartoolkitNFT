! function(e) {
"use strict";
var t = function(e, t, a) {
this.width = e, this.height = t, this.root = new THREE.Object3D, this.root.matrixAutoUpdate = !1, this.config = a, this.listeners = {}, this.version = "0.5.1", console.log("ARnft ", this.version)
};
t.prototype.init = function(n, o) {
console.log("ARnft init() %cstart...", "color: yellow; background-color: blue; border-radius: 4px; padding: 2px");
var r = this.root;
(async function(e, t) {
return await new Promise((function(t, a) {
const i = new XMLHttpRequest;
i.open("GET", e), i.responseType = "json", i.onload = function() {
t(i.response)
}, i.onerror = function() {
a("error " + i.status)
}, i.send(null)
}))
})(this.config).then((function(d) {
! function(e) {
var t = document.createElement("div");
t.id = "loading";
var a = document.createElement("img");
a.src = e.loading.logo.src, a.alt = e.loading.logo.alt;
var i = document.createElement("span");
i.setAttribute("class", "loading-text"), i.innerText = e.loading.loadingMessage, t.appendChild(a), t.appendChild(i);
document.getElementById("marker");
document.body.insertBefore(t, document.body.firstChild)
}(d),
function(e) {
if(e) {
var t = document.createElement("div");
t.id = "stats", t.className = "ui stats";
var a = document.createElement("div");
a.id = "stats1", a.className = "stats-item";
var i = document.createElement("p");
i.className = "stats-item-title", i.innerText = "Main", a.appendChild(i), t.appendChild(a);
var n = document.createElement("div");
n.id = "stats2", n.className = "stats-item";
var o = document.createElement("p");
o.className = "stats-item-title", o.innerText = "Worker", n.appendChild(o), t.appendChild(n);
var r = document.getElementById("loading");
document.body.insertBefore(t, r)
}
}(o);
var s, c, l = function() {
var e = document.createElement("div");
e.id = "app";
var t = document.createElement("canvas");
t.id = "canvas";
var a = document.createElement("video");
a.id = "video", a.setAttribute("autoplay", ""), a.setAttribute("muted", ""), a.setAttribute("playsinline", ""), e.appendChild(a), e.appendChild(t);
var i = document.getElementById("loading");
return document.body.insertBefore(e, i), {
container: e,
canvas: t,
video: a
}
}(),
u = (l.container, l.canvas),
m = l.video;
o && ((s = new Stats).showPanel(0), document.getElementById("stats1").appendChild(s.dom), (c = new Stats).showPanel(0), document.getElementById("stats2").appendChild(c.dom)),
function(n, o, r, d, s, c, l) {
var u = l.videoSettings.facingMode || "environment",
m = l.onError || function(e) {
console.error("ARnft internal getUserMedia", e)
},
g = !1,
v = ["touchstart", "touchend", "touchmove", "touchcancel", "click", "mousedown", "mouseup", "mousemove", "keydown", "keyup", "keypress", "scroll"],
p = function() {
g && (r.play().then((function() {
! function(t, n, o, r, d, s, c, l, u, m) {
var g, v, p, h, f, w, y, E, b, k, x, M, S, T = document.createElement("canvas"),
U = T.getContext("2d"),
P = new THREE.WebGLRenderer({
canvas: s,
alpha: m.renderer.alpha,
antialias: m.renderer.antialias,
precision: m.renderer.precision
});
P.setPixelRatio(e.devicePixelRatio);
var R = new THREE.Scene,
A = new THREE.Camera;
A.matrixAutoUpdate = !1, R.add(A);
var L = new THREE.AmbientLight(16777215);
R.add(L), R.add(u);
var N;

function C() {
self.onmessage = function(i) {
var n = i.data;
switch (n.type) {
case "load":
return void
function(e) {
var i, n, o, r = self.origin;
console.debug("Base path:", r);
var d = /https?:\/\/(www\.)?[-a-zA-Z0-9@:%._\+~#=]{2,256}\.[a-z]{2,6}\b([-a-zA-Z0-9@:%_\+.~#()?&//=]*)/gim.test(e.artoolkitUrl);
1 == d ? i = e.addPath ? r + "/" + e.addPath + "/" + e.artoolkitUrl : e.artoolkitUrl : 0 == d && (e.addPath ? (console.debug("addPath exist: ", e.addPath), i = r + "/" + e.addPath + "/" + e.artoolkitUrl) : i = r + "/" + e.artoolkitUrl);
console.debug("Importing WASM lib from: ", i), importScripts(i), self.addEventListener("artoolkitNFT-loaded", (function() {
var i = /https?:\/\/(www\.)?[-a-zA-Z0-9@:%._\+~#=]{2,256}\.[a-z]{2,6}\b([-a-zA-Z0-9@:%_\+.~#()?&//=]*)/gim.test(e.camera_para);
1 == i ? n = e.addPath ? r + "/" + e.addPath + "/" + e.camera_para : e.camera_para : 0 == i && (n = e.addPath ? r + "/" + e.addPath + "/" + e.camera_para : r + "/" + e.camera_para), console.debug("Loading camera at:", n);
var d = new ARCameraParamNFT(n, (function() {
var i = (t = new ARControllerNFT(e.pw, e.ph, d)).getCameraMatrix();
t.addEventListener("getNFTMarker", (function(e) {
a = {
type: "found",
matrixGL_RH: JSON.stringify(e.data.matrixGL_RH),
proj: JSON.stringify(i)
}
}));
var n = /https?:\/\/(www\.)?[-a-zA-Z0-9@:%._\+~#=]{2,256}\.[a-z]{2,6}\b([-a-zA-Z0-9@:%_\+.~#()?&//=]*)/gim.test(e.marker);
1 == n ? o = e.addPath ? r + "/" + e.addPath + "/" + e.marker : e.marker : 0 == n && (o = e.addPath ? r + "/" + e.addPath + "/" + e.marker : r + "/" + e.marker), console.debug("Loading NFT marker at: ", o), t.loadNFTMarker(o, (function(e) {
t.trackNFTMarkerId(e), console.log("loadNFTMarker -> ", e), postMessage({
type: "endLoading",
end: !0
})
})), postMessage({
type: "loaded",
proj: JSON.stringify(i)
})
}), (function(e) {
console.error(e)
}))
}))
}(n);
case "process":
return e = n.imagedata, void
function() {
a = null, t && t.process && t.process(e);
a ? postMessage(a) : postMessage({
type: "not found"
});
e = null
}()
}
};
var e = null,
t = null,
a = null
}
var H = function(e) {
N = e ? JSON.parse(e.matrixGL_RH) : null
},
_ = Date.now();

function I() {
U.fillStyle = "black", U.fillRect(0, 0, b, k), U.drawImage(o, 0, 0, g, v, x, M, y, E);
var e = U.getImageData(0, 0, b, k);
S.postMessage({
type: "process",
imagedata: e
}, [e.data.buffer])
}
var j = function() {
O(), requestAnimationFrame(j)
},
O = function() {
c();
var e = Date.now();
if(e - _, _ = e, N) {
u.visible = !0;
for(var t = 0; t < 16; t++) a.delta[t] = N[t] - a.interpolated[t], a.interpolated[t] = a.interpolated[t] + a.delta[t] / 24;
i(u.matrix, a.interpolated)
} else u.visible = !1;
P.render(R, A)
};
(function() {
g = r, v = d, f = 320 / Math.max(g, v / 3 * 4), w = /Android|mobile|iPad|iPhone/i.test(navigator.userAgent) ? e.outerWidth / r : 1, p = g * w, h = v * w, y = g * f, E = v * f, b = Math.max(y, E / 3 * 4), k = Math.max(E, y / 4 * 3), x = (b - y) / 2, M = (k - E) / 2, T.style.clientWidth = b + "px", T.style.clientHeight = k + "px", T.width = b, T.height = k, P.setSize(p, h);
var t = new Blob([C.toString().replace(/^function .+\{?|\}$/g, "")], {
type: "text/js-worker"
}),
a = URL.createObjectURL(t);
(S = new Worker(a)).postMessage({
type: "load",
pw: b,
ph: k,
camera_para: m.cameraPara,
marker: n,
artoolkitUrl: m.artoolkitUrl,
addPath: m.addPath
}), S.onmessage = function(e) {
var t = e.data;
switch (t.type) {
case "loaded":
var a = JSON.parse(t.proj),
n = b / y,
o = k / E;
a[0] *= n, a[4] *= n, a[8] *= n, a[12] *= n, a[1] *= o, a[5] *= o, a[9] *= o, a[13] *= o, i(A.projectionMatrix, a);
break;
case "endLoading":
if(1 == t.end) {
var r = document.getElementById("loading");
r && (r.querySelector(".loading-text").innerText = "Start the tracking!", setTimeout((function() {
r.parentElement.removeChild(r)
}), 2e3))
}
break;
case "found":
H(t);
break;
case "not found":
H(null)
}
l(), I()
}
})(), j(), I()
}(0, o, r, r.videoWidth, r.videoHeight, d, (function() {
c.stats && c.statsMain.update()
}), (function() {
c.stats && c.statsWorker.update()
}), s, l)
})).catch((function(e) {
m(e), t._teardownVideo(r)
})), r.paused || v.forEach((function(t) {
e.removeEventListener(t, p, !0)
})))
};
v.forEach((function(t) {
e.addEventListener(t, p, !0)
}));
var h = function(t) {
if(e.URL.createObjectURL) try {
r.srcObject = t
} catch (e) {}
r.srcObject = t, g = !0, r.autoplay = !0, r.playsInline = !0, p()
},
f = {},
w = {};
l.videoSettings.width && (w.width = l.videoSettings.width, "object" == typeof l.videoSettings.width ? (l.videoSettings.width.max && (f.maxWidth = l.videoSettings.width.max), l.videoSettings.width.min && (f.minWidth = l.videoSettings.width.min)) : f.maxWidth = l.videoSettings.width);
l.videoSettings.height && (w.height = l.videoSettings.height, "object" == typeof l.videoSettings.height ? (l.videoSettings.height.max && (f.maxHeight = l.videoSettings.height.max), l.videoSettings.height.min && (f.minHeight = l.videoSettings.height.min)) : f.maxHeight = l.videoSettings.height);
w.facingMode = u, w.deviceId = l.videoSettings.deviceId, navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia;
var y = {
audio: !1,
video: f
};
navigator.mediaDevices || e.MediaStreamTrack.getSources ? navigator.mediaDevices ? navigator.mediaDevices.getUserMedia({
audio: !1,
video: w
}).then(h, m) : e.MediaStreamTrack.getSources((function(e) {
var t = w.facingMode;
u && u.exact && (t = u.exact);
for(var a = 0; a < e.length; a++)
if("video" === e[a].kind && e[a].facing === t) {
y.video.mandatory.sourceId = e[a].id;
break
} u && u.exact && !y.video.mandatory.sourceId ? m("Failed to get camera facing the wanted direction") : navigator.getUserMedia ? navigator.getUserMedia(y, h, m) : m("navigator.getUserMedia is not supported on your browser")
})) : navigator.getUserMedia ? navigator.getUserMedia(y, h, m) : m("navigator.getUserMedia is not supported on your browser")
}(0, n, m, u, r, {
statsMain: s,
statsWorker: c,
stats: o
}, d)
}))
}, t.prototype.add = function(e) {
this.root.add(e)
}, t.prototype.loadModel = function(e, t, a, i, n) {
var o, r = this.root;
(new THREE.GLTFLoader).load(e, (function(e) {
(o = e.scene).scale.set(n, n, n), o.rotation.x = Math.PI / 2, o.position.x = t, o.position.y = a, o.position.z = i, o.matrixAutoUpdate = !1, r.add(o)
}))
}, t.prototype.dispatchEvent = function(e) {
var t = this.listeners[e.name];
if(t)
for(var a = 0; a < t.length; a++) t[a].call(this, e)
}, t.prototype.addEventListener = function(e, t) {
this.listeners[e] || (this.listeners[e] = []), this.listeners[e].push(t)
}, t.prototype.removeEventListener = function(e, t) {
if(this.listeners[e]) {
var a = this.listeners[e].indexOf(t);
a > -1 && this.listeners[e].splice(a, 1)
}
}, t._teardownVideo = function(e) {
e.srcObject.getVideoTracks()[0].stop(), e.srcObject = null, e.src = null
};
var a = {
delta: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
interpolated: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
},
i = function(e, t) {
var a = [];
for(var i in t) a[i] = t[i];
"function" == typeof e.elements.set ? e.elements.set(a) : e.elements = [].slice.call(a)
};
e.ARnft = t, e.THREE = THREE
}(window);
